{% extends 'base.html.twig' %}

{% block title %}Hello MainController!{% endblock %}

{% block body %}
<style>
    .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }

    #hed{font-size: 14px;}
</style>

<div class="example-wrapper">
    <h1>Hello {{ controller_name }}! âœ…</h1>

    <button class="btn btn-primary" onclick="request()">Send Recognition Request & write to history database</button> <br> <br>
	<textarea id="input" rows="3"></textarea>

<table class="table table-secondary table-hover">
  <theadclass="thead-dark">
    <tr>
      <th scope="col">Requested At</th>
      <th scope="col">Source Text</th>
      <th scope="col">Recognized language</th>
      <th scope="col">isReliable</th>
      <th scope="col">Confidence score</th>
    </tr>
  </thead>
  <tbody id="hed">
     {#% for m in measurements %} 
     <tr>
        <td>{{m.requestedAt|date('H:m d-m-Y')}}</td>
        <td>{{m.stationId}}</td>
        <td>{{m.station}}</td>
        <td>{{m.date}}</td>
        <td>{{m.temp}}</td>
        <td>{{m.windDir}}</td>
        <td>{{m.windSpeed}}</td>
        <td>{{m.relativeHumidity}}</td>
        <td>{{m.dropSum}}</td>
        <td>{{m.pressure}}</td>
    </tr>
    {% endfor %#}
  </tbody>
</table>


</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}

<script>

function request()
{
	let url = "{{path ('lng') }}";

	$.ajax({
		url: url,
		method: "post", 
		data: JSON.stringify(
			{'q':$("#input").val()})
		})
	.done(res => 
	{ 
        if (res == '0')
            alert("Request failed");
        else
        {
            let json = JSON.parse(res);
            console.log(json);

            let trc = '';

            

    
            
            json.data.detections.forEach(function(detection) 
            {
              let tdHtml = `<td scope="row">${json.id_stacji}</td><td scope="row">${json.stacja}</td><td scope="row">${json.data_pomiaru} ${json.godzina_pomiaru}</td><td scope="row">${json.temperatura}</td><td scope="row">${json.kierunek_wiatru}</td><td scope="row">${json.predkosc_wiatru}</td><td scope="row">${json.wilgotnosc_wzgledna}</td><td scope="row">${json.suma_opadu}</td><td scope="row">${json.cisnienie}</td>`;
              
              if(trc == '')
              {
                trc = document.createElement('tr');
                trc.innerHTML = '<td scope="row">now (frontend)</td><td scope="row">'+$("#input").val()+'</td>';
                document.getElementById('hed').prepend(trc);
              }
              else
              {
              trc = document.createElement('tr');
              trc.innerHTML = tdHtml;
              document.getElementById('hed').prepend(trc);
              }
            }

            
            
        }
        

		
	});
}
</script>
{% endblock %}
